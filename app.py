import streamlit as st
from dotenv import load_dotenv
import os
from langchain_openai import ChatOpenAI
from langchain_core.messages import SystemMessage, HumanMessage

# ======================================
# .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
# ======================================
load_dotenv()  # â† ã“ã‚Œã§OPENAI_API_KEYãŒè‡ªå‹•ã§èª­ã¿è¾¼ã¾ã‚Œã‚‹

# ======================================
# Streamlitãƒšãƒ¼ã‚¸è¨­å®š
# ======================================
st.set_page_config(page_title="å°‚é–€å®¶ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª", layout="centered")

st.title("ğŸ’¬ å°‚é–€å®¶AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ")
st.write("ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒ ã«è³ªå•ã‚’å…¥åŠ›ã—ã€å°‚é–€å®¶ã®ã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦é€ä¿¡ã—ã¦ãã ã•ã„ã€‚")

# ======================================
# ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ï¼šå°‚é–€å®¶ã®ç¨®é¡ã‚’é¸æŠ
# ======================================
expert = st.radio(
    "å°‚é–€å®¶ã®ç¨®é¡ã‚’é¸ã‚“ã§ãã ã•ã„ï¼š",
    ("æ—…è¡Œãƒ—ãƒ©ãƒ³ãƒŠãƒ¼", "æ „é¤Šå£«", "å¿ƒç†ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼", "ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼")
)

# ======================================
# ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
# ======================================
user_input = st.text_area("è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:")

# ======================================
# LLMã¸ã®å•ã„åˆã‚ã›é–¢æ•°ã‚’å®šç¾©
# ======================================
def ask_expert(expert_type, user_text):
    """å°‚é–€å®¶ã‚¿ã‚¤ãƒ—ã¨å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚‚ã¨ã«LLMã¸è³ªå•ã—ã€å›ç­”ã‚’è¿”ã™é–¢æ•°"""

    # LLMåˆæœŸåŒ–
    llm = ChatOpenAI(model="gpt-3.5-turbo", temperature=0.7)

    # å°‚é–€å®¶ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
    if expert_type == "æ—…è¡Œãƒ—ãƒ©ãƒ³ãƒŠãƒ¼":
        role_prompt = "ã‚ãªãŸã¯ãƒ—ãƒ­ã®æ—…è¡Œãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã§ã™ã€‚"
    elif expert_type == "æ „é¤Šå£«":
        role_prompt = "ã‚ãªãŸã¯æ „é¤Šå£«ã¨ã—ã¦ã€é£Ÿäº‹ã¨å¥åº·ã®å°‚é–€å®¶ã§ã™ã€‚"
    elif expert_type == "å¿ƒç†ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼":
        role_prompt = "ã‚ãªãŸã¯å„ªã—ãå‚¾è´ã™ã‚‹å¿ƒç†ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼ã§ã™ã€‚"
    elif expert_type == "ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼":
        role_prompt = "ã‚ãªãŸã¯ç†Ÿç·´ã—ãŸã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚"
    else:
        role_prompt = "ã‚ãªãŸã¯çŸ¥è­˜è±Šå¯Œãªå°‚é–€å®¶ã§ã™ã€‚"

    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä½œæˆ
    messages = [
        SystemMessage(content=role_prompt),
        HumanMessage(content=user_text)
    ]

    # LLMã«å•ã„åˆã‚ã›
    response = llm.invoke(messages)

    # å›ç­”ã‚’è¿”ã™
    return response.content

# ======================================
# é€ä¿¡ãƒœã‚¿ãƒ³
# ======================================
if st.button("é€ä¿¡"):
    if user_input.strip() == "":
        st.warning("è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
    else:
        with st.spinner("AIãŒå›ç­”ã‚’ç”Ÿæˆä¸­..."):
            answer = ask_expert(expert, user_input)
        st.success("å›ç­”ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼")
        st.write(f"### ğŸ§  {expert}ã®å›ç­”:")
        st.write(answer)
